## [JPA] 8. í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬
**ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë°** ê³µë¶€ ê¸°ë¡

<br><br>

#### ğŸ‘€ í”„ë¡ì‹œì™€ ì¦‰ì‹œ ë¡œë”©, ì§€ì—° ë¡œë”©
í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë©´ ì—°ê´€ëœ ê°ì²´ë¥¼ ì²˜ìŒë¶€í„° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•  ìˆ˜ ìˆë”°. ìì£¼ ì‚¬ìš©í•˜ëŠ” ê°ì²´ë“¤ì€ ì¡°ì¸ì„ ì‚¬ìš©í•˜ì—¬ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì¼ ìˆ˜ë„ ìˆë‹¤. JPAëŠ” `ì¦‰ì‹œ ë¡œë”©`ê³¼ `ì§€ì—° ë¡œë”©`ìœ¼ë¡œ ì´ ë‘˜ì„ ëª¨ë‘ ì§€ì›í•œë‹¤.

<br><hr><br>

### ğŸ“ 8.1 í”„ë¡ì‹œ
ì—”í‹°í‹°ë¥¼ ì¡°íšŒ í•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì´ í•­ìƒ ì‚¬ìš©ë˜ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ë”°ë¼ ì—°ê´€ëœ ì—”í‹°í‹°ê°€ ì‚¬ìš©ë  ë•Œë„, ê·¸ë ‡ì§€ ì•Šì„ ë•Œë„ ìˆë‹¤.

JPAëŠ” ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì—”í‹°í‹°ê°€ ì‹¤ì œ ì‚¬ìš©ë  ë•Œ ê¹Œì§€ DB ì¡°íšŒë¥¼ ì§€ì—°í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•˜ëŠ”ë° ì´ê²ƒì„ `ì§€ì—° ë¡œë”©`ì´ë¼ê³  í•œë‹¤.

<br>

ì§€ì—° ë¡œë”©ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ ëŒ€ì‹ ì— DBë¥¼ ì¡°íšŒë¥¼ ì§€ì—°í•  ìˆ˜ ìˆëŠ” ê°€ì§œ ê°ì²´ê°€ í•„ìš”í•œë° ì´ë¥¼ `í”„ë¡ì‹œ ê°ì²´`ë¼ í•œë‹¤.

<br>

`em.find()` vs `em.getReference()`
- `em.find()` : ì—”í‹°í‹° ì¡°íšŒ. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ë‹¤ë©´ DBë¥¼ ì¡°íšŒ
- `em.getReference()` : DBë¥¼ ì¡°íšŒí•˜ì§€ ì•Šê³  ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ ìƒì„± X. DB ì ‘ê·¼ì„ ìœ„ì„í•œ í”„ë¡ì‹œ ê°ì²´ ë°˜í™˜

<hr>

#### ğŸ’­ í”„ë¡ì‹œ íŠ¹ì§•
- ì‹¤ì œ í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì•„ì„œ ë§Œë“¤ì–´ì§
- ì‹¤ì œ í´ë˜ìŠ¤ì™€ ê²‰ ëª¨ì–‘ì´ ê°™ë‹¤
- ì‚¬ìš©í•˜ëŠ” ì…ì¥ì—ì„œëŠ” ì§„ì§œ ê°ì²´ì¸ì§€ í”„ë¡ì‹œ ê°ì²´ì¸ì§€ êµ¬ë¶„í•˜ì§€ ì•Šê³  ì‚¬ìš©í•˜ë©´ ë¨
- ì‹¤ì œ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ë³´ê´€
- í”„ë¡ì‹œ ê°ì²´ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ì‹¤ì œ ê°ì²´ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œ


<hr>

#### ğŸ’­ í”„ë¡ì‹œ ê°ì²´ì˜ ì´ˆê¸°í™”
```java
Member findMember = em.getReference(Member.class, m.getId());
//System.out.println(findMember.getClass());
//System.out.println(findMember.getId());
System.out.println(findMember.getUserName());
```

![](https://images.velog.io/images/jodawooooon/post/97197ce5-81fc-4d02-9ff1-643c42aaa9cc/image.png)

1. `findMember.getUserName()` í˜¸ì¶œí•´ì„œ ì‹¤ì œ ë°ì´í„° ì¡°íšŒ
2. ì‹¤ì œ ì—”í‹°í‹°ê°€ ìƒì„±ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ `ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸`ì— ì´ˆê¸°í™” ìš”ì²­ (ì—”í‹°í‹° ìƒì„± ìš”ì²­)
3. `ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸`ê°€ DBë¥¼ ì¡°íšŒì—ì„œ ì‹¤ì œ ì—”í‹°í‹° ìƒì„±
4. `í”„ë¡ì‹œ ê°ì²´`ëŠ” ìƒì„±ëœ ì—”í‹°í‹° ê°ì²´ì˜ ì°¸ì¡°ë¥¼ `Member target` ë©¤ë²„ë³€ìˆ˜ì— ë³´ê´€
5. `í”„ë¡ì‹œ ê°ì²´`ëŠ” ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ì˜ `getUserName()`ì„ í˜¸ì¶œí•´ì„œ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.

<hr>

í”„ë¡ì‹œì˜ íŠ¹ì§•

- ì²˜ìŒ ì‚¬ìš©í•  ë•Œ í•œ ë²ˆë§Œ ì´ˆê¸°í™” (2ë²ˆ ë¶ˆê°€ëŠ¥)


- í”„ë¡ì‹œ ê°ì²´ë¥¼ ì´ˆê¸°í™” í•  ë•Œ í”„ë¡ì‹œ ê°ì²´ê°€ ì‹¤ì œ ì—”í‹°í‹°ë¡œ ë°”ë€ŒëŠ” ê²ƒì€ ì•„ë‹˜. í”„ë¡ì‹œ ê°ì²´ê°€ ì´ˆê¸°í™” ë˜ë©´ í”„ë¡ì‹œ ê°ì²´ë¥¼ í†µí•´ì„œ ì‹¤ì œ ì—”í‹°í‹°ì— ì ‘ê·¼ ê°€ëŠ¥

- í”„ë¡ì‹œ ê°ì²´ëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ìƒì† ë°›ìœ¼ë¯€ë¡œ íƒ€ì… ì²´í¬ì‹œ ì£¼ì˜í•´ì•¼í•¨ ( == ë¹„êµ ëŒ€ì‹ ì— instance of ì‚¬ìš©)
```java
Member findMember1 = em.getReference(Member.class, m.getId());
System.out.println(findMember1.getClass() == Member.class); //false
System.out.println(findMember1 instanceof Member); //true
```


<br>

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì°¾ëŠ” ì—”í‹°í‹°ê°€ ì´ë¯¸ ìˆìœ¼ë©´ DBë¥¼ ì¡°íšŒí•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ `em.getReference()`ë¥¼ í˜¸ì¶œí•´ë„ ì‹¤ì œ ì—”í‹°í‹° ë°˜í™˜

```java
Member findMember1 = em.find(Member.class, m.getId());
Member findMember2 = em.getReference(Member.class, m.getId());
System.out.println(findMember1.getClass());
System.out.println(findMember2.getClass());
   ```

   ```
   // ì¶œë ¥ => ë‘˜ë‹¤ ì—”í‹°í‹° ë°˜í™˜
   class com.jpa.db.Member
class com.jpa.db.Member
   ```


<br>

- ì¤€ì˜ì† ìƒíƒœì¼ ë•Œ, í”„ë¡ì‹œë¥¼ ì´ˆê¸°í™”í•˜ë©´ ì˜ˆì™¸ ë°œìƒ ( ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì´ˆê¸°í™” ë¶ˆê°€ëŠ¥ )
```java
em.detach(findMember1);
System.out.println(findMember1.getUserName());
```
```
//ì»¤ë„¥ì…˜ ì—ëŸ¬
org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl stop
```
<br>
<br>

#### ğŸ’­ í”„ë¡ì‹œ í™•ì¸
`PersistenceUnitUtil().isLoaded()` : í”„ë¡ì‹œ ì¸ìŠ¤í„´ìŠ¤ì˜ ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸

```java
Member refMember = em.getReference(Member.class, m.getId());
//System.out.println(refMember.getClass());
System.out.println(emf.getPersistenceUnitUtil().isLoaded(refMember));

```
ì´ˆê¸°í™” ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° false ë°˜í™˜. ì´ë¯¸ ì´ˆê¸°í™” ë˜ì—ˆê±°ë‚˜ í”„ë¡ì‹œ ì¸ìŠ¤í„´ìŠ¤ê°€ ì•„ë‹ ê²½ìš° true ë°˜í™˜

<br><br>


## ğŸ“ 8.2 ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©

í”„ë¡ì‹œ ê°ì²´ëŠ” ì£¼ë¡œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì§€ì—° ë¡œë”© í• ë•Œ ì‚¬ìš©í•œë‹¤.

JPAëŠ” ì—°ê´€ëœ ì—”í‹°í‹°ì˜ ì¡°íšŒ ì‹œì ì„ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ `ì§€ì—°ë¡œë”©`, `ì¦‰ì‹œë¡œë”©` ë‘ ê°€ì§€ ë°©ë²•ì„ ì œê³µí•œë‹¤.

### ğŸ’­ ì§€ì—° ë¡œë”© (`LAZY`ë¥¼ ì‚¬ìš©í•´ì„œ í”„ë¡ì‹œë¡œ ì¡°íšŒ)


Member ì—”í‹°í‹°
```java
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    private String userName;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name="TEAM_ID")
    private Team team;
    ...
```

í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
Team t = new Team();
t.setName("teamA");
em.persist(t);

Member m = new Member();
m.setUserName("HELLO");
m.setTeam(t);
em.persist(m);

em.flush();
em.clear();

Member findMember = em.find(Member.class, m.getId());

System.out.println(findMember.getTeam().getClass());
System.out.println("===========================");
System.out.println(findMember.getTeam().getName()); // ì‹¤ì œ teamì„ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— ì´ˆê¸°í™”(DB ì¡°íšŒ)
tx.commit();
```

ì¶œë ¥ ê²°ê³¼
```
Hibernate: 
    select
        member0_.id as id1_3_0_,
        member0_.TEAM_ID as TEAM_ID3_3_0_,
        member0_.userName as userName2_3_0_ 
    from
        Member member0_ 
    where
        member0_.id=?
class com.jpa.db.Team$HibernateProxy$4y1KwunM //ë°˜í™˜ëœ ê°ì²´ëŠ” í”„ë¡ì‹œ ê°ì²´
===========================
Hibernate: 
    select
        team0_.id as id1_5_0_,
        team0_.name as name2_5_0_ 
    from
        Team team0_ 
    where
        team0_.id=?
teamA
```

- `Member findMember = em.find(Member.class, m.getId());`
í˜¸ì¶œí•˜ë©´ `Member`ë§Œ ì¡°íšŒí•˜ê³  `Team`ì€ ì¡°íšŒí•˜ì§€ ì•ŠëŠ”ë‹¤.
ëŒ€ì‹  `Team` ë©¤ë²„ë³€ìˆ˜ì— `í”„ë¡ì‹œ ê°ì²´`ë¥¼ ë„£ì–´ë‘”ë‹¤.


- `findMember.getTeam().getClass()`ì‹œ ë°˜í™˜ëœ ê°ì²´ëŠ” í”„ë¡ì‹œ ê°ì²´ì´ë‹¤. ì´ ê°ì²´ëŠ” ì‹¤ì œ ì‚¬ìš©ë  ë•Œ ê¹Œì§€ ë°ì´í„° ë¡œë”©ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤. => **ì§€ì—° ë¡œë”©**


ì¡°íšŒí•œ `Team` ì—”í‹°í‹°ë¥¼ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— JPAê°€ SQLë¥¼ í˜¸ì¶œí•´ì„œ íŒ€ ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.

<br>

### ğŸ’­ ì¦‰ì‹œ ë¡œë”© (`EAGER`ë¥¼ ì‚¬ìš©í•´ì„œ í•¨ê»˜ ì¡°íšŒ)
Memberì™€ Teamì„ ìì£¼ í•¨ê»˜ ì‚¬ìš©í•œë‹¤ë©´? ì¦‰ì‹œ ë¡œë”© (`EAGER`) ë¥¼ ì‚¬ìš©í•´ì„œ í•¨ê»˜ ì¡°íšŒí•œë‹¤



Member ì—”í‹°í‹°
```java
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    private String userName;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name="TEAM_ID")
    private Team team;
    
    ...
    
```
í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
Team t = new Team();
t.setName("teamA");
em.persist(t);

Member m = new Member();
m.setUserName("HELLO");
m.setTeam(t);
em.persist(m);

em.flush();
em.clear();

Member findMember = em.find(Member.class, m.getId()); //ì¡°ì¸ì„ ì‚¬ìš©í•´ì„œ SQL í•œë²ˆì— í•¨ê»˜ ì¡°íšŒ

System.out.println(findMember.getTeam().getClass());
System.out.println("===========================");
System.out.println(findMember.getTeam().getName()); 
tx.commit();
```

ì¶œë ¥ ê²°ê³¼

```java
Hibernate: 
    select
        member0_.id as id1_3_0_,
        member0_.TEAM_ID as TEAM_ID3_3_0_,
        member0_.userName as userName2_3_0_,
        team1_.id as id1_5_1_,
        team1_.name as name2_5_1_ 
    from
        Member member0_ 
    left outer join
        Team team1_ 
            on member0_.TEAM_ID=team1_.id 
    where
        member0_.id=?
class com.jpa.db.Team
===========================
teamA
```

- `Member findMember = em.find(Member.class, m.getId());` 
í˜¸ì¶œ ì‹œ `Member` ë¿ë§Œ ì•„ë‹ˆë¼ `Team`ë„ í•¨ê»˜ ì¡°íšŒí•œë‹¤. ì´ ë•Œ Memberì™€ Teamì„ ì¡°ì¸í•´ì„œ ì¿¼ë¦¬ í•œ ë²ˆìœ¼ë¡œ ë‘ ì—”í‹°í‹°ë¥¼ ëª¨ë‘ ì¡°íšŒí•œë‹¤.


<br><br>

### ğŸ’­ ì¦‰ì‹œ ë¡œë”© ì£¼ì˜
- ì‹¤ë¬´ì—ì„œ ê°€ê¸‰ì  ì§€ì—° ë¡œë”© ì‚¬ìš©
	ì¦‰ì‹œ ë¡œë”©ì€ ì˜ˆìƒì¹˜ ëª»í•œ SQLì´ ë°œìƒí•œë‹¤
    ë˜í•œ JPQLì—ì„œ N+1 ë¬¸ì œë¥¼ ì¼ìœ¼í‚¨ë‹¤
- `@ManyToOne`, `@OneToOne`ì€ ê¸°ë³¸ì´ ì¦‰ì‹œë¡œë”©ì´ë‹¤ => `LAZY`ë¡œ ë³€ê²½

<br><br>

### ğŸ’­ ì§€ì—° ë¡œë”© í™œìš©
- ëª¨ë“  ì—°ê´€ê´€ê³„ì— ì§€ì—° ë¡œë”©ì„ í™œìš©
- ì‹¤ë¬´ì—ì„œëŠ” ì¦‰ì‹œ ë¡œë”© ì‚¬ìš© X

<br><br>

## ğŸ“ 8.4 ì˜ì†ì„± ì „ì´ : CASCADE

ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ê³  ì‹¶ì„ ë•Œ `CASCADE` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

ex) ë¶€ëª¨ ì—”í‹°í‹° ì €ì¥ ì‹œ ìì‹ ì—”í‹°í‹°ë„ í•¨ê»˜ ì €ì¥

Parent, Child Entity
```java
@Entity
public class Parent {

    @Id
    @GeneratedValue
    @Column(name="PARENT_ID")
    private Long id;

    private String name;

    @OneToMany(mappedBy = "parent", cascade = CascadeType.PERSIST)
    private List<Child> childList = new ArrayList<>();

    public void addChild(Child child){
        childList.add(child);
        child.setParent(this);
    }
    
    ...
    
    
    
@Entity
public class Child {
    @Id
    @GeneratedValue
    private Long id;

    private String name;

    @ManyToOne
    @JoinColumn(name="PARENT_ID")
    private Parent parent;
    
    
```

í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
Child c1 = new Child();
Child c2 = new Child();

Parent p = new Parent();
p.addChild(c1);
p.addChild(c2);

//ë¶€ëª¨ ì €ì¥, ì—°ê´€ëœ ìì‹ë„ í•¨ê»˜ ì €ì¥
em.persist(p);
```
<br>

#### ğŸ’­ CASCADE ì˜µì…˜ ì¢…ë¥˜
â€¢ `ALL` : ëª¨ë‘ ì ìš©
â€¢ `PERSIST` : ì˜ì†
â€¢ `REMOVE` : ì‚­ì œ
â€¢ `MERGE` : ë³‘í•©
â€¢ `REFRESH` : REFRESH
â€¢ `DETACH` : DETACH

<br><br>

## ğŸ“ 8.5 ê³ ì•„ ê°ì²´
ë¶€ëª¨ ì—”í‹°í‹°ì™€ ì—°ê´€ ê´€ê³„ê°€ ëŠì–´ì§„ ìì‹ ì—”í‹°í‹°ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥
=> ê³ ì•„ ê°ì²´(ORPHAN) ì œê±°

ë¶€ëª¨ ì—”í‹°í‹°ì˜ ì»¬ë ‰ì…˜ì—ì„œ ìì‹ ì—”í‹°í‹°ì˜ ì°¸ì¡°ë§Œ ì œê±°í•˜ë©´ ìì‹ ì—”í‹°í‹°ê°€ ìë™ìœ¼ë¡œ ì‚­ì œ


```java
@Entity
public class Parent {

    @Id
    @GeneratedValue
    private Long id;

    private String name;

    @OneToMany(mappedBy = "parent", orphanRemoval = true)
    private List<Child> childList = new ArrayList<>();
```

`childList` ì»¬ë ‰ì…˜ì—ì„œ ì œê±°í•œ ì—”í‹°í‹°ëŠ” ìë™ìœ¼ë¡œ ì‚­ì œëœë‹¤ê³  í•œë‹¤.
=> ê·¸ëŸ¬ë‚˜ í…ŒìŠ¤íŠ¸ í•´ë´¤ì„ ë•Œ `orphanRemoval = true`ë§Œìœ¼ë¡œëŠ” ì»¬ë ‰ì…˜ì—ì„œ ì²« ë²ˆì§¸ ìì‹ì„ ì œê±°í–ˆì„ ë•Œ ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ê°€ ì‚­ì œ ë˜ì§€ ì•Šì•˜ë‹¤. 
ê´€ë ¨ ìë£Œ : https://github.com/jyami-kim/Jyami-Java-Lab/issues/1

<br>

ë¶€ëª¨ë¥¼ ì œê±°í•˜ë©´ ìì‹ì€ ê³ ì•„ê°€ ëœë‹¤. ë”°ë¼ì„œ `orphanRemoval = true` í•˜ë©´, ë¶€ëª¨ë¥¼ ì œê±°í•  ë•Œ ìì‹ë„ í•¨ê»˜ ì œê±°ëœë‹¤. ì´ê²ƒì€ `CascadeType.REMOVE`ì²˜ëŸ¼ ë™ì‘í•œë‹¤.

<br><br>

## ğŸ“ 8.6 ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´, ìƒëª…ì£¼ê¸°
`CascadeType.ALL` + `orphanRemoval = true` ì„ ë‘˜ë‹¤ í™œì„±í™”í•˜ë©´ ë¶€ëª¨ ì—”í‹°í‹°ë¥¼ í†µí•´ì„œ ìì‹ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

- ìì‹ì„ ì €ì¥í•˜ë ¤ë©´ ë¶€ëª¨ì— ë“±ë¡ë§Œ í•˜ë©´ ëœë‹¤ (`CASCADE`)
- ìì‹ì„ ì‚­ì œí•˜ë ¤ë©´ ë¶€ëª¨ì—ì„œ ì œê±°í•˜ë©´ ëœë‹¤ (`orphanRemoval`)


<br><br>
