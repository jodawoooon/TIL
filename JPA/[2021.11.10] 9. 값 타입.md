# [JPA] 9. ê°’ íƒ€ì…
**ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë°** ê³µë¶€ ê¸°ë¡

<br>

- ê¸°ë³¸ ê°’ íƒ€ì…
	- ìë°” ê¸°ë³¸ íƒ€ì…
    - ë˜í¼ í´ë˜ìŠ¤
    - String
- ì„ë² ë””ë“œ íƒ€ì…
- ì»¬ë ‰ì…˜ ê°’ íƒ€ì…
<br><br>
## ğŸ“ ê¸°ë³¸ ê°’ íƒ€ì…
ì˜ˆ) `String name`, `int age`

- ìƒëª…ì£¼ê¸°ë¥¼ ì—”í‹°í‹°ì— ì˜ì¡´í•œë‹¤.
ë”°ë¼ì„œ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë©´ `name`, `age`ë„ ì œê±°ëœë‹¤.

- ê°’ íƒ€ì…ì€ ê³µìœ í•˜ë©´ ì•ˆ ëœë‹¤.
ê¸°ë³¸ íƒ€ì…ì€ í•­ìƒ ê°’ì„ ë³µì‚¬í•¨. 
`Integer`ê°™ì€ ë˜í¼ í´ë˜ìŠ¤ë‚˜ `String` ê°™ì€ íŠ¹ìˆ˜í•œ í´ë˜ìŠ¤ì— ê²½ìš° ê°ì²´ì§€ë§Œ ìë°” ì—ì„œ ê¸°ë³¸ íƒ€ì…ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì§€ì›. ì´ë“¤ì€ ê°ì²´ì§€ë§Œ ë³€ê²½ X

<br><br>

## ğŸ“ ì„ë² ë””ë“œ íƒ€ì…

ìƒˆë¡œìš´ ê°’ íƒ€ì…ì„ ì§ì ‘ ì •ì˜í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒ
=> ì§ì ‘ ì •ì˜í•œ ì„ë² ë””ë“œ íƒ€ì…ë„ ê°’ íƒ€ì…ì´ë‹¤

- `@Embedded` : ê°’ íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” ê³³ 
- `@Embeddable` : ê°’ íƒ€ì…ì„ ì •ì˜í•˜ëŠ” ê³³
ê¸°ë³¸ ìƒì„±ì í•„ìˆ˜

<br>

### ğŸ’­ ì„ë² ë””ë“œ íƒ€ì…ì˜ ì¥ì 
- ì¬ì‚¬ìš©
- ë†’ì€ ì‘ì§‘ë„
- í•´ë‹¹ ê°’ íƒ€ì…ë§Œ ì‚¬ìš©í•˜ëŠ” ì˜ë¯¸ìˆëŠ” ë©”ì†Œë“œ ë§Œë“¤ ìˆ˜ ìˆìŒ
- ê°’ íƒ€ì…ì„ ì†Œìœ í•œ ì—”í‹°í‹°ì— ìƒëª…ì£¼ê¸°ë¥¼ ì˜ì¡´í•¨
<br><br>

```java
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    private String userName;

    @Embedded
    private Period workPriod;

    @Embedded
    private Address homeAddress;
	
    ...
    
    

@Embeddable
public class Address {
    //ì§‘ ì£¼ì†Œ í‘œí˜„
    private String city;
    private String street;
    private String zipcode;
    
    ...
}

@Embeddable
public class Period {
    //ê·¼ë¬´ê¸°ê°„
    private LocalDate startDate;
    private LocalDate endDate;
    
    ...
```

<br>

### ğŸ’­ `@AttributeOverride` : ì†ì„± ì¬ì •ì˜

ì„ë² ë””ë“œ íƒ€ì…ì— ì •ì˜í•œ ë§¤í•‘ ì •ë³´ë¥¼ ì¬ì •ì˜í•˜ë ¤ë©´ `@AttributeOverride`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´ Memberì—ê²Œ ì£¼ì†Œê°€ 2ê°œ í•„ìš”í•˜ë‹¤ë©´

```java
@Entity
public class Member {

    ...

    @Embedded
    private Address homeAddress;
    @Embedded
    private Address companyAddress;
    ...
```

ìœ„ ìƒí™©ì—ì„œ ë¬¸ì œëŠ” í…Œì´ë¸”ì— ë§¤í•‘í•˜ëŠ” ì»¬ëŸ¼ëª…ì´ ì¤‘ë³µë˜ëŠ” ê²ƒì´ë‹¤. (ê° Address ì•ˆì˜ ì»¬ëŸ¼ ëª…ì´ ë™ì¼)

ì´ ë•ŒëŠ” `@AttributeOverride`ì„ ì‚¬ìš©í•´ì„œ ë§¤í•‘ ì •ë³´ë¥¼ ì¬ì •ì˜í•œë‹¤.

```java
@Entity
public class Member {

    ...

    @Embedded
    private Address homeAddress;
    @Embedded
    @AttributeOverrides({
    	@AttributeOverride(name="city", column=@Column(name="COMPANY_CITY")),
        @AttributeOverride(name="street", column=@Column(name="COMPANY_STREET")),
        @AttributeOverride(name="zipcode", column=@Column(name="COMPANY_ZIPCODE"))
    })
    private Address companyAddress;
    ...
```

<br><br>


## ğŸ“ ê°’ íƒ€ì…ê³¼ ë¶ˆë³€ ê°ì²´

### ğŸ’­ ê°’ íƒ€ì… ê³µìœ  ì°¸ì¡°
ì„ë² ë””ë“œ íƒ€ì…ì€ ì—¬ëŸ¬ ì—”í‹°í‹°ì—ì„œ ê³µìœ í•˜ë©´ ìœ„í—˜í•˜ë‹¤

```java
            Address address = new Address("TEST","TEST","TEST");

            Member m1 = new Member();
            m1.setUserName("TEST1");
            m1.setHomeAddress(address);
            em.persist(m1);

            Member m2 = new Member();
            m2.setUserName("TEST2");
            m2.setHomeAddress(address);
            em.persist(m2);

            m1.getHomeAddress().setCity("NewCity");
```

![](https://images.velog.io/images/jodawooooon/post/d1e17fe8-896f-457a-8c56-56c1b623c590/image.png)

member1ì˜ ì£¼ì†Œë§Œ "NewCity"ë¡œ ë³€ê²½ë˜ê¸¸ ê¸°ëŒ€í–ˆì§€ë§Œ ë©¤ë²„2ì˜ ì£¼ì†Œë„ ê°™ì´ ë³€ê²½ë˜ì—ˆë‹¤. ë‘˜ì´ ê°™ì€ Addressë¥¼ ì°¸ì¡°í•˜ê¸° ë•Œë¬¸ì´ë‹¤. ì´ëŸ¬í•œ ê³µìœ  ì°¸ì¡°ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë²„ê·¸ëŠ” ì°¾ê¸° ì–´ë µë‹¤. ì´ëŸ° ë¶€ì‘ìš©ì„ ë§‰ê¸° ìœ„í•´ì„œëŠ” ê°’ì„ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.


<br>

### ğŸ’­ ê°’ íƒ€ì… ë³µì‚¬


```java
            Address address = new Address("TEST","TEST","TEST");

            Member m1 = new Member();
            m1.setUserName("TEST1");
            m1.setHomeAddress(address);
            em.persist(m1);

            Address newAddress = new Address(address.getCity(), address.getStreet(), address.getZipcode());

            Member m2 = new Member();
            m2.setUserName("TEST2");
            m2.setHomeAddress(newAddress);
            em.persist(m2);


            m1.getHomeAddress().setCity("NewCity");
```

ê¸°ì¡´ `address`ë¥¼ ë³µì‚¬í•˜ì—¬ `newAddress`ë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ìœ„ ê³¼ì •ì„ ë°˜ë³µí•˜ë©´ ì˜ë„í•œëŒ€ë¡œ ë™ì‘í•œë‹¤.
![](https://images.velog.io/images/jodawooooon/post/54786aee-dc72-4a2f-b605-c717e4f2b291/image.png)

<br>

ê°ì²´ ëŒ€ì… ì‹œ ë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë³µì‚¬í•´ì„œ ëŒ€ì…í•˜ë©´ `ê³µìœ  ì°¸ì¡°`ë¥¼ í”¼í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ ë³µì‚¬í•˜ì§€ ì•Šê³  ì›ë³¸ì˜ ì°¸ì¡° ê°’ì„ ì§ì ‘ ë„˜ê¸°ëŠ” ê²ƒì„ ë§‰ì„ ìˆ˜ ì—†ë‹¤. ìë°”ëŠ” ê·¸ì € ê¸°ë³¸íƒ€ì…ì´ë©´ ê°’ì„ ë³µì‚¬í•´ì„œ ë„˜ê¸°ê³  ê°ì²´ë©´ ì°¸ì¡°ë¥¼ ë„˜ê¸´ë‹¤.

**ê°ì²´ì˜ `ê³µìœ  ì°¸ì¡°`ëŠ” í”¼í• ìˆ˜ê°€ ì—†ë‹¤.**
=> `setter` ì‚¬ìš©ì„ í•˜ì§€ ë§ì•„ì•¼ í•œë‹¤.
<br>

### ğŸ’­ ë¶ˆë³€ ê°ì²´

- ë¶ˆë³€ ê°ì²´ : ìƒì„± ì‹œì  ì´í›„ ì ˆëŒ€ ê°’ì„ ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ê°ì²´

ê°ì²´ë¥¼ ë¶ˆë³€í•˜ê²Œ ë§Œë“¤ë©´ ë¶€ì‘ìš©ì„ ì°¨ë‹¨í•  ìˆ˜ ìˆë‹¤.
ê°’ íƒ€ì…ì€ ê°€ëŠ¥í•˜ë©´ ë¶ˆë³€ ê°ì²´ë¡œ ì„¤ê³„í•œë‹¤.
=> ìƒì„±ìë§Œ ê°’ì„ ì„¤ì •í•˜ê³  `setter` ìƒì„± X

<br><br>

## ğŸ“ ê°’ íƒ€ì…ì˜ ë¹„êµ

â€¢ ë™ì¼ì„± ë¹„êµ: ì¸ìŠ¤í„´ìŠ¤ì˜ ì°¸ì¡° ê°’ì„ ë¹„êµ, `==` 
â€¢ ë™ë“±ì„± ë¹„êµ: ì¸ìŠ¤í„´ìŠ¤ì˜ ê°’ì„ ë¹„êµ, `equals()`


ê°’ íƒ€ì…ì€ ì¸ìŠ¤í„´ìŠ¤ê°€ ë‹¬ë¼ë„ ê·¸ ì•ˆì´ ê°™ìœ¼ë©´ ê°™ì€ ê²ƒìœ¼ë¡œ ë´ì•¼í•œë‹¤. ë”°ë¼ì„œ ê°’ íƒ€ì…ì„ ë¹„êµí•  ë•ŒëŠ” `equals()`ë¥¼ ì‚¬ìš©í•´ì„œ ë™ë“± ë¹„êµë¥¼ í•´ì•¼í•œë‹¤. 

```java

@Embeddable
public class Address {
    //ì§‘ ì£¼ì†Œ í‘œí˜„
    private String city;
    private String street;
    private String zipcode;
    
    ...
    
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Address address = (Address) o;
        return Objects.equals(city, address.city) && Objects.equals(street, address.street) && Objects.equals(zipcode, address.zipcode);
    }

    @Override
    public int hashCode() {
        return Objects.hash(city, street, zipcode);
    }
}
```
<br><br>

## ğŸ“ ê°’ íƒ€ì… ì»¬ë ‰ì…˜

ê°’ íƒ€ì…ì„ í•˜ë‚˜ ì´ìƒ ì €ì¥í•˜ë ¤ë©´ ì»¬ë ‰ì…˜ì— ë³´ê´€í•˜ë©´ ëœë‹¤
- `@ElementCollection`, `@CollectionTable` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
- ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì€ `ì˜ì†ì„± ì „ì´(Cascade)` + `ê³ ì•„ ê°ì²´ ì œê±°` ê¸°ëŠ¥ì„ í•„ìˆ˜ë¡œ ê°€ì§„ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤
- ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì€ ì¡°íšŒì‹œ `LAZY`ê°€ ê¸°ë³¸ì´ë‹¤.

```java
Member m = new Member();
m.setUserName("TEST");
m.setHomeAddress(new Address("TEST","TE","ST"));

m.getFavoriteFoods().add("Chicken");
m.getFavoriteFoods().add("Pizza");

m.getAddressHistory().add(new Address("TEST2","TE2","ST2"));
m.getAddressHistory().add(new Address("TEST3","TE3","ST3"));

em.persist(m);


em.flush();
em.clear();

System.out.println("=======================================");
Member findMember = em.find(Member.class, m.getId());
```

ì¶œë ¥
```
=======================================
Hibernate: 
    select
        member0_.MEMBER_ID as MEMBER_I1_6_0_,
        member0_.city as city2_6_0_,
        member0_.street as street3_6_0_,
        member0_.zipcode as zipcode4_6_0_,
        member0_.userName as userName5_6_0_ 
    from
        Member member0_ 
    where
        member0_.MEMBER_ID=?
```
ì§€ì—° ë¡œë”©ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
<br><br>

```java
System.out.println("=======================================");
Member findMember = em.find(Member.class, m.getId());
System.out.println("=======================================");

List<Address> addressHistory = findMember.getAddressHistory();

for(Address address : addressHistory){
	System.out.println(address.getCity());
}

System.out.println("=======================================");

Set<String> favoriteFoods = findMember.getFavoriteFoods();
for(String food : favoriteFoods){
	System.out.println(food);
}
```

ì¶œë ¥ í™•ì¸
```
=======================================
Hibernate: 
    select
        member0_.MEMBER_ID as MEMBER_I1_6_0_,
        member0_.city as city2_6_0_,
        member0_.street as street3_6_0_,
        member0_.zipcode as zipcode4_6_0_,
        member0_.userName as userName5_6_0_ 
    from
        Member member0_ 
    where
        member0_.MEMBER_ID=?
=======================================
Hibernate: 
    select
        addresshis0_.MEMBER_ID as MEMBER_I1_0_0_,
        addresshis0_.city as city2_0_0_,
        addresshis0_.street as street3_0_0_,
        addresshis0_.zipcode as zipcode4_0_0_ 
    from
        ADDRESS addresshis0_ 
    where
        addresshis0_.MEMBER_ID=?
TEST2
TEST3
=======================================
Hibernate: 
    select
        favoritefo0_.MEMBER_ID as MEMBER_I1_4_0_,
        favoritefo0_.FOOD_NAME as FOOD_NAM2_4_0_ 
    from
        FAVORITE_FOODS favoritefo0_ 
    where
        favoritefo0_.MEMBER_ID=?
Pizza
Chicken

```
ìœ„ì™€ ê°™ì´ ì‹¤ì œ ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•  ë•Œ SELECT SQLì„ í•œë²ˆ ì”© í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

<br><br>

### ğŸ’­ ê°’ íƒ€ì… ìˆ˜ì •

ê°’ íƒ€ì…ì€ ì—”í‹°í‹°ì™€ ë‹¤ë¥´ê²Œ ì‹ë³„ìë¼ëŠ” ê°œë…ì´ ì—†ìœ¼ë¯€ë¡œ ë³€ê²½í•˜ë©´ ì¶”ì ì´ ì•ˆëœë‹¤.
ë”°ë¼ì„œ ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì— ë³€ê²½ ì‚¬í•­ì´ ë°œìƒí•˜ë©´, ì£¼ì¸ ì—”í‹°í‹°ì™€ ì—°ê´€ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³ , ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì— ìˆëŠ” í˜„ì¬ ê°’ì„ ëª¨ë‘ ë‹¤ì‹œ ì €ì¥í•œë‹¤.

```java

===================== homeAddress


//ê°’íƒ€ì…ì€ ì™„ì „íˆ êµì²´
Address a = findMember.getHomeAddress();
findMember.setHomeAddress(new Address("newCity", a.getStreet(), a.getZipcode()));
      
      
      
Hibernate: 
    /* update
        com.jpa.db.Member */ update
            Member 
        set
            city=?,
            street=?,
            zipcode=?,
            userName=? 
        where
            MEMBER_ID=?
            
            
            
            
===================== favoriteFoods                
            
            
//ì¹˜í‚¨=>í•œì‹
Set<String> favFoods = findMember.getFavoriteFoods();
findMember.getFavoriteFoods().remove("Chicken");
findMember.getFavoriteFoods().add("Korean Food");
         


Hibernate: 
    /* delete collection row com.jpa.db.Member.favoriteFoods */ delete 
        from
            FAVORITE_FOODS 
        where
            MEMBER_ID=? 
            and FOOD_NAME=?
Hibernate: 
    /* insert collection
        row com.jpa.db.Member.favoriteFoods */ insert 
        into
            FAVORITE_FOODS
            (MEMBER_ID, FOOD_NAME) 
        values
            (?, ?)
            
            
            
===================== addressHistory            
            
            
findMember.getAddressHistory().remove(new Address("TEST2","TE2","ST2"));
//equalsë¥¼ ì œëŒ€ë¡œ êµ¬í˜„í•´ì•¼ ì§€ì›Œì§„ë‹¤.
findMember.getAddressHistory().add(new Address("newCity2","TE2","ST2"));



Hibernate: 
    /* delete collection com.jpa.db.Member.addressHistory */ delete 
        from
            ADDRESS 
        where
            MEMBER_ID=?
Hibernate: 
    /* insert collection
        row com.jpa.db.Member.addressHistory */ insert 
        into
            ADDRESS
            (MEMBER_ID, city, street, zipcode) 
        values
            (?, ?, ?, ?)
Hibernate: 
    /* insert collection
        row com.jpa.db.Member.addressHistory */ insert 
        into
            ADDRESS
            (MEMBER_ID, city, street, zipcode) 
        values
            (?, ?, ?, ?)

// 2ë²ˆ ì¸ì„œíŠ¸ ??

```
=> í˜„ì¬ ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì— ë°ì´í„°ê°€ 2ê°œ ìˆì–´ì„œ 2ë²ˆ INSERT ë˜ì—ˆë‹¤. 
=> ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì— ë³€ê²½ ì‚¬í•­ì´ ë°œìƒí•˜ë©´, ì£¼ì¸ ì—”í‹°í‹°ì™€ ì—°ê´€ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³ , ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì— ìˆëŠ” í˜„ì¬ ê°’ì„ ëª¨ë‘ ë‹¤ì‹œ ì €ì¥í•œë‹¤.

<br>

â“â“ ê·¼ë° ì™œ `Set<String>` ì˜ ê²½ìš°ì—ëŠ” 1ë²ˆ deleteí•˜ê³  1ë²ˆ insertê°€ ë ê¹Œ? Setì´ë¼ì„œ? 
`List<String>`ìœ¼ë¡œ ë³€ê²½í•˜ë©´ 1ë²ˆ deleteí•˜ê³  2ë²ˆ insertê°€ ì¼ì–´ë‚¨.
ê·¸ë¦¬ê³  `List<Address>`ë¥¼ `Set<Address>`ë¡œ ë³€ê²½í•  ê²½ìš°ì—ëŠ” ë˜ 1ë²ˆ deleteí–ˆë‹¤ê°€ 2ë²ˆ insertê°€ ì¼ì–´ë‚œë‹¤.. ì•„ë¬´ë¦¬ ì°¾ì•„ë´ë„ ëª¨ë¥´ê² ë‹¤
  
<br>  

ì•„ë¬´íŠ¼ ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì— ë°ì´í„°ê°€ ë§ë‹¤ë©´ ì„±ëŠ¥ì— ë¬¸ì œê°€ ìƒê¸°ë¯€ë¡œ ì‹¤ë¬´ì—ì„œëŠ” ì‚¬ìš©í•˜ë©´ ... ì•ˆ ëœë‹¤. 
ê°’ íƒ€ì… ì»¬ë ‰ì…˜ ëŒ€ì‹ ì— ì¼ëŒ€ë‹¤ ê´€ê³„ë¥¼ ê³ ë ¤í•´ì•¼ í•œë‹¤.


<br><br>

## ğŸ“ ì—”í‹°í‹° íƒ€ì… vs ê°’ íƒ€ì…

### ğŸ’­ ì—”í‹°í‹° íƒ€ì…
- ì‹ë³„ìê°€ ìˆë‹¤
- ìƒëª…ì£¼ê¸°ê°€ ìˆë‹¤
- `em.persist`ë¡œ ì˜ì†í™” í•œë‹¤
- `em.remove`ë¡œ ì œê±°í•œë‹¤
- ê³µìœ í•  ìˆ˜ ìˆë‹¤ (ê³µìœ  ì°¸ì¡°)

<br>


### ğŸ’­ ì—”í‹°í‹° íƒ€ì…
- ì‹ë³„ìê°€ ì—†ë‹¤
- ìƒëª…ì£¼ê¸°ë¥¼ ì—”í‹°í‹°ì— ì˜ì¡´í•œë‹¤
- ê³µìœ í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤ (ë¶ˆë³€ ê°ì²´í™” ì•ˆì „)