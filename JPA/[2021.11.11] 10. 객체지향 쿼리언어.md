# [JPA] 10. ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´

**ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë°** ê³µë¶€ ê¸°ë¡

<br>

ëª©ì°¨
* ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì†Œê°œ
* JPQL
* Criteria
* QueryDSL
* Native SQL
* ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì‹¬í™”

<br>

## ğŸ“ 10.1 ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì†Œê°œ

í…Œì´ë¸”ì´ ì•„ë‹Œ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰ í•„ìš”í•¨

### ğŸ’­ JPQL
* í…Œì´ë¸”ì´ ì•„ë‹Œ ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰í•˜ëŠ” **ê°ì²´ì§€í–¥ ì¿¼ë¦¬**
* SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì • DB SQLì— ì˜ì¡´ X

<br>

ì˜ˆì œ - íšŒì›ì´ë¦„ì´ KIMì¸ ì—”í‹°í‹° ì¡°íšŒ
```java
List<Member> memberList = em.createQuery(
	"select m from Member m where m.userName like '%KIM%'", Member.class
).getResultList();

            
Hibernate: 
    /* select
        m 
    from
        Member m 
    where
        m.userName like '%KIM%' */ select
            member0_.MEMBER_ID as MEMBER_I1_6_,
            member0_.city as city2_6_,
            member0_.street as street3_6_,
            member0_.zipcode as zipcode4_6_,
            member0_.userName as userName5_6_ 
        from
            Member member0_ 
        where
            member0_.userName like '%KIM%'
```

<br>

### ğŸ’­ Criteria ì¿¼ë¦¬

JPQLì„ ìƒì„±í•˜ëŠ” ë¹Œë” í´ë˜ìŠ¤
ë¬¸ìê°€ ì•„ë‹Œ í”„ë¡œê·¸ë˜ë° ì½”ë“œë¡œ JPQLì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.
- ì»´íŒŒì¼ ì‹œì ì— ì˜¤ë¥˜ ë°œê²¬ 
- IDEë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë“œ ìë™ì™„ì„± ì§€ì›
- ë™ì  ì¿¼ë¦¬ ì‘ì„± í¸í•¨

```java
//Criteria ì‚¬ìš©ì¤€ë¹„
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> query = cb.createQuery(Member.class);
            
//Root í´ë˜ìŠ¤
Root<Member> m = query.from(Member.class);

//ì¿¼ë¦¬ ìƒì„±
CriteriaQuery<Member> cq = query.select(m).where(cb.equal(m.get("userName"), "KIM"));
List<Member> memberList = em.createQuery(cq).getResultList();



Hibernate: 
    /* select
        generatedAlias0 
    from
        Member as generatedAlias0 
    where
        generatedAlias0.userName=:param0 */ select
            member0_.MEMBER_ID as MEMBER_I1_6_,
            member0_.city as city2_6_,
            member0_.street as street3_6_,
            member0_.zipcode as zipcode4_6_,
            member0_.userName as userName5_6_ 
        from
            Member member0_ 
        where
            member0_.userName=?
```

ì¥ì ì€ ë§ì§€ë§Œ** ì‹¤ë¬´ì—ì„  ì•ˆì”€ **
ë³µì¡í•´ì„œ ì‹¤ìš©ì„±ì´ ì—†ê³  ìš´ì˜í•˜ê¸° ì–´ë ¤ì›€

<br>

### ğŸ’­ QueryDSL 

Criteriaì²˜ëŸ¼ JPQL ë¹Œë” ì—­í• ì„ í•¨
ì½”ë“œ ê¸°ë°˜ì´ë©´ì„œ ë‹¨ìˆœí•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰½ë‹¤
ì»´íŒŒì¼ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŒ

â€¢ ë™ì ì¿¼ë¦¬ ì‘ì„± í¸ë¦¬í•¨
â€¢ ë‹¨ìˆœí•˜ê³  ì‰¬ì›€
â€¢ ì‹¤ë¬´ ì‚¬ìš© ê¶Œì¥


<br>


### ğŸ’­ ë„¤ì´í‹°ë¸Œ SQL

JPAê°€ ì œê³µí•˜ëŠ” SQLì„ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥
íŠ¹ì • DBì— ì˜ì¡´í•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ë•Œ í•„ìš”
í‘œì¤€í™” ë˜ì–´ ìˆì§€ ì•Šì€ ê²ƒë“¤ì€ JPQLì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. ë˜í•œ SQLì€ ì§€ì›í•˜ì§€ë§Œ JPQLì´ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ëŠ¥ë„ ìˆë‹¤.

=> ë„¤ì´í‹°ë¸Œ SQL

ë‹¨ì ì€ íŠ¹ì • DBì— ì˜ì¡´ì ì´ë¯€ë¡œ DBë¥¼ ë³€ê²½í•˜ë©´ ë„¤ì´í‹°ë¸Œ SQLë„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

<br>

### ğŸ’­ JDBC ì§ì ‘ ì‚¬ìš©, SpringJdbcTemplate ë“±

JPAì™€ í•¨ê»˜ JDBC ì»¤ë„¥ì…˜ì„ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜, ìŠ¤í”„ë§
JdbcTemplate, MyBatis ë“± í•¨ê»˜ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤


<br>

#### flushê°€ ë˜ëŠ” ì‹œì ì€ commitë  ë•Œì™€ queryê°€ ë‚ ì•„ê°ˆ ë•Œì´ë‹¤.

`flush`ëŠ” commitë˜ê¸° ì§ì „ì—ë„ í˜¸ì¶œë˜ì§€ë§Œ emì„ í†µí•´ JPQL queryê°€ ë‚ ì•„ê°ˆ ë•Œë„ ì§ì „ì— `flush`ê°€ ëœë‹¤ (auto)
**JPA ê´€ë ¨ëœ ê¸°ìˆ ì„ ì“¸ ë•ŒëŠ” í¬ê²Œ ë¬¸ì œê°€ ì•ˆëœë‹¤.**

<br>

ë‹¤ë§Œ DB ì»¤ë„¥ì…˜ì„ ë”°ë¡œ ì–»ì–´ì™€ì„œ JPAë¥¼ ìš°íšŒí•´ì„œ DBì— ì ‘ê·¼í•  ê²½ìš°ì—ëŠ” ë¬¸ì œê°€ ëœë‹¤. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ DBë¥¼ ë¶ˆì¼ì¹˜ ìƒíƒœë¡œ ë§Œë“¤ì–´ì„œ ë°ì´í„° ë¬´ê²°ì„±ì„ í›¼ì†í•  ìˆ˜ ìˆë‹¤.

JDBCë‚˜ MyBatisë¥¼ JPAì™€ í•¨ê»˜ ì‚¬ìš©í•˜ë ¤ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì ì ˆí•œ ì‹œì ì— ê°•ì œë¡œ í”ŒëŸ¬ì‹œ í•´ì•¼í•œë‹¤.

JPA ìš°íšŒí•´ì„œ SQL ì‹¤í–‰í•˜ê¸° ì§ì „ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ `flush`í•´ì„œ **DBì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë™ê¸°í™”**í•œë‹¤.

<br><br>

## ğŸ“Œ 10.2 JPQL
- ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´
í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬í•¨

- SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì •ë°ì´í„°ë² ì´ìŠ¤ SQLì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤

<br>

### ğŸ“ JPQL ë¬¸ë²•

- ì—”í‹°í‹°ì™€ ì†ì„±ì€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ O (Member, age)
- JPQL í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ê°€ êµ¬ë¶„ X (SELECT ...)
- Entity ëª… ì‚¬ìš© (í…Œì´ë¸” ì´ë¦„ X)
- ë³„ì¹­ì€ í•„ìˆ˜ (Member m)

<br>

### TypeQuery, Query

ì‘ì„±í•œ JPQLì„ ì‹¤í–‰í•˜ë ¤ë©´ ì¿¼ë¦¬ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤. 
ì¿¼ë¦¬ ê°ì²´ëŠ” TypeQueryì™€ Queryê°€ ìˆë‹¤
- TypeQuery : ë°˜í™˜í•  íƒ€ì…ì„ ëª…í™•í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë©´ ì‚¬ìš©
```java
TypedQuery<Member> query = em.createQuery("select m from Member m", Member.class);
```

- Query : ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©
```java
Query query = em.createQuery("select m.userName, m.age from Member m");
```

<br>


### ê²°ê³¼ ì¡°íšŒ API
- `query.getResultList`
ê²°ê³¼ê°€ í•˜ë‚˜ ì´ìƒì¼ ë•Œ, ë¦¬ìŠ¤íŠ¸ ë°˜í™˜. 
ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜`

- `query.getResultList`
ê²°ê³¼ê°€ ì •í™•íˆ í•˜ë‚˜, ë‹¨ì¼ ê°ì²´ ë°˜í™˜
ì˜ˆì™¸ ë°œìƒ
  - ê²°ê³¼ê°€ ì—†ìœ¼ë©´: `javax.persistence.NoResultException`
  - ë‘˜ ì´ìƒì´ë©´: `javax.persistence.NonUniqueResultException`

<br><br>

### ğŸ“ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

JDBCëŠ” ìœ„ì¹˜ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ë§Œ ì§€ì›í•˜ì§€ë§Œ JPQLì€ ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ë„ ì§€ì›í•œë‹¤.

- ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„°
ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„°ëŠ” ì•ì— `:`ë¥¼ ì‚¬ìš©í•œë‹¤
```java
String usernaeParam = "User1";

TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m where m.username=:username", Member.class);
query.setParameter("username", usernameParam);
```
- ìœ„ì¹˜ ê¸°ì¤€ íŒŒë¼ë¯¸í„°
`?` ë‹¤ìŒì— ìœ„ì¹˜ ê°’ì„ ì£¼ë©´ ëœë‹¤
```java
String usernaeParam = "User1";

TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m where m.username=?1", Member.class);
query.setParameter(1, usernameParam);
```

ìœ„ì¹˜ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ë°©ì‹ ë³´ë‹¤ëŠ” `ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ë°©ì‹`ì„ ì‚¬ìš©í•˜ëŠ”ê²Œ ë” ëª…í™•í•˜ë‹¤.

**SQL ì¸ì ì…˜ ê³µê²©ì´ë‚˜ ì „ì²´ì ì¸ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ë°©ì‹ì€ ì„ íƒì´ ì•„ë‹Œ í•„ìˆ˜ì´ë‹¤! **

<br><br>

### ğŸ“ í”„ë¡œì ì…˜

SELECT ì ˆì— ì¡°íšŒí•  ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ê²ƒì„ `í”„ë¡œì ì…˜`ì´ë¼ê³  í•œë‹¤.
í”„ë¡œì ì…˜ ëŒ€ìƒ : ì—”í‹°í‹°, ì„ë² ë””ë“œ íƒ€ì…, ìŠ¤ì¹¼ë¼ íƒ€ì´

- ì—”í‹°í‹° í”„ë¡œì ì…˜
`em.createQuery("select m from Member m", Member.class).getResultList();
`
ì—”í‹°í‹° í”„ë¡œì ì…˜ì—ì„œ ì¡°íšŒí•œ ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë‹¤ ê´€ë¦¬ëœë‹¤.

- ì„ë² ë””ë“œ íƒ€ì… í”„ë¡œì ì…˜
`em.createQuery("select o.address from Order o", Address.class).getResultList();
`
ì„ë² ë””ë“œ íƒ€ì…ì€ ì—”í‹°í‹° íƒ€ì…ì´ ì•„ë‹Œ ê°’ íƒ€ì…ì´ë‹¤. ë”°ë¼ì„œ ì„ë² ë””ë“œ íƒ€ì…ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ”ë‹¤.

- ìŠ¤ì¹¼ë¼ íƒ€ì… í”„ë¡œì ì…˜
ë¬¸ì, ìˆ«ì, ë‚ ì§œì™€ ê°™ì€ ê¸°ë³¸ ë°ì´í„° íƒ€ì…ì„ ìŠ¤ì¹¼ë¼ íƒ€ì…ì´ë¼ í•œë‹¤.

<br>

### new ëª…ë ¹ì–´ë¡œ ì¡°íšŒ
```

public class MemberDTO {
    private String userName;
    private int age;

    public MemberDTO(String userName, int age) {
        this.userName = userName;
        this.age = age;
    }
}




List<MemberDTO> list = em.createQuery("select new jpql.MemberDTO(m.userName, m.age) from Member m", MemberDTO.class).getResultList();

```

`select` ë‹¤ìŒì— `new` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ë°˜í™˜ë°›ì„ í´ë˜ìŠ¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆëŠ”ë° ì´ í´ë˜ìŠ¤ì˜ ìƒì„±ìì— JPQL ì¡°íšŒ ê²°ê³¼ë¥¼ ë„˜ê²¨ì¤„ ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  `new` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•œ í´ë˜ìŠ¤ë¡œ `TypeQuery`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ ê°ì²´ ë³€í™˜ ì‘ì—…ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.


<br><br>

### ğŸ“ í˜ì´ì§• API

â€¢ `setFirstResult(int startPosition)` : ì¡°íšŒ ì‹œì‘ ìœ„ì¹˜ (0ë¶€í„° ì‹œì‘)
â€¢ `setMaxResults(int maxResult)` : ì¡°íšŒí•  ë°ì´í„° ìˆ˜

ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ (`Dialect`) ë•ë¶„ì— ê°ê¸° ë‹¤ë¥¸ DBë§ˆë‹¤ ê°™ì€ APIë¡œ í˜ì´ì§• ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.

<br><br>

### ğŸ“ ì„œë¸Œ ì¿¼ë¦¬
- `FROM` ì ˆì˜ ì„œë¸Œ ì¿¼ë¦¬ëŠ” í˜„ì¬ JPQLì—ì„œ ë¶ˆê°€ëŠ¥
=> ì¡°ì¸ìœ¼ë¡œ í’€ ìˆ˜ ìˆìœ¼ë©´ í’€ì–´ì„œ í•´ê²°

<br><br>

### ğŸ“ ì¡°ê±´ì‹

#### ğŸ’­ íƒ€ì… í‘œí˜„
- ë¬¸ì
ì‘ì€ ë”°ì˜´í‘œ ì‚¬ì´ì— í‘œí˜„í•œë‹¤. ì‘ì€ ë”°ì˜´í‘œ í‘œí˜„í•˜ë ¤ë©´ ì—°ì† ë‘ê°œ(`''`) ì‚¬ìš©
ex) `'Hello'`, `'She''s'`

- ìˆ«ì : `10L(Long)`, `10D(Double)`, `10F(Float)`
- Boolean: `TRUE`, `FALSE` 

- Enum 
íŒ¨í‚¤ì§€ëª…ì„ í¬í•¨í•œ ì „ì²´ ì´ë¦„ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤

ex ) `jpql.MemberType.ADMIN`

```java
            String query = "select m.userName, 'HELLO', TRUE from Member m "
                    + "where m.memberType = :userType";

            List<Object[]> result = em.createQuery(query)
                    .setParameter("userType", jpql.MemberType.ADMIN)
                    .getResultList();

            for(Object[] objects : result){
                System.out.println(objects[0]);
                System.out.println(objects[1]);
                System.out.println(objects[2]);
            }
            
            
 Hibernate: 
    /* select
        m.userName,
        'HELLO',
        TRUE 
    from
        Member m 
    where
        m.memberType = :userType */ 
        select
            member0_.userName as col_0_0_,
            'HELLO' as col_1_0_,
            1 as col_2_0_ 
        from
            Member member0_ 
        where
            member0_.memberType=?
TEST
HELLO
true
```

- ì—”í‹°í‹°
ì—”í‹°í‹°ì˜ íƒ€ì…ì„ í‘œí˜„í•œë‹¤. ì£¼ë¡œ ìƒì† ê´€ë ¨í•´ì„œ ì‚¬ìš©
ex) `TYPE(m) = Member`

<br>

#### ğŸ’­ ì¡°ê±´ì‹ - CASE ì‹

íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ ë¶„ê¸°í•  ë•Œ CASE ì‹ì„ ì‚¬ìš©í•¨. ì¢…ë¥˜ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤

- ê¸°ë³¸ CASE
```java
            String query = "select " +
                    "case when m.age <= 10 then 'í•™ìƒìš”ê¸ˆ' " +
                    "     when m.age >= 60 then 'ê²½ë¡œìš”ê¸ˆ' " +
                    "       else 'ì¼ë°˜ìš”ê¸ˆ' " +
                    "end "+
                    "from Member m " +
                    "";

            List<String> result = em.createQuery(query, String.class)
                    .getResultList();
```
- ì‹¬í”Œ CASE
ì¡°ê±´ì‹ì´ ì—†ê³  ë¬¸ë²•ì´ ë‹¨ìˆœ (ìë°”ì˜ `switch`ì™€ ìœ ì‚¬)

- COALESCE
ìŠ¤ì¹¼ë¼ì‹ì„ ì°¨ë¡€ëŒ€ë¡œ ì¡°íšŒí•´ì„œ `null`ì´ ì•„ë‹ˆë©´ ë°˜í™˜í•œë‹¤.

- NULLIF

<br><br>